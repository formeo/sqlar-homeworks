# Домашнее задание к занятию "Репликация и резервное копирование"


### Цель задания

В результате выполнения этого задания вы:

1. Научитесь работать с WAL-логами
2. Попрактикуетесь в настройке механизма логической репликации
3. Поработаете с процедурами резервного копирования

------

### Чеклист готовности к домашнему заданию

1. Есть ранее созданная БД PostgreSQL для выполнения заданий.

### Пререквизиты

Поднять второй экземпляр БД - "test2" PostgreSQL для выполнения задач по репликации. 

Для этого:
1. Создать второй экземпляр
    - выполните команду:  ``/usr/lib/postgresql/15/bin/initdb -D /var/lib/postgresql/15_2/main``
2. Для работы экземпляра требуется сменить порт работы с дефолтного 5432, на котором работает 1-ый экземпляр, на порт 5433, на котором будет работать 2-ой экземпляр.
    - выполните команду: ``vi /var/lib/postgresql/15_2/main/postgresql.conf``, где /var/lib/postgresql/15_2/main/postgresql.conf является файлом конфигурации.
  
3. Запустить второй экземпляр
    - выполните команду:  ``/usr/lib/postgresql/15/bin/pc_ctl -D /var/lib/postgresql/15_2/main start``
4. Если потребуется перезапустить второй экземпляр
	  - выполните команду:  ``/usr/lib/postgresql/15/bin/pc_ctl -D /var/lib/postgresql/15_2/main restart``

---

### Задание 1

1. проверьте текущую роль сервера , определите текущий сгенерированный WAL-лог, выполнив команду в соответствии с ролью сервера, покажите что на файловой системе этот последний лог является свежим изменяемым логом (с использованием команды шел 'ls').
2. сделайте дамп таблицы с данными в тестовой БД test и импортируейте его в БД test2.
3. почистите импортированную таблицу, с которой работали в пункте 2 данного задания в БД test2 и настройте репликацию для нее в БД test2 из БД test (с опцией репликаций операций только UPDATE), убедитесь что репликация работает при выполнении апдейтов в БД test.

### Задание 2

1. определите текущий сгенерированный WAL-лог на сервере, а затем выполните команду переключения WAL-лога. Подтвердите, что он переключился (номер лога изменился).
2. сделайте дамп таблицы в тестовой БД test и импортируейте его в БД test2 без данных.
3. настройте репликацию для БД test2 из БД test для таблицы, с которой работали в пункте 2 данного задания (с опцией репликации только INSERT и UPDATE операций). Убедитесь, что репликация работает при выполнении изменений в БД test.

### Задание 3*

1. создайте таблицу с имеющимся в ней PRIMARY KEY в БД test и настройте для нее репликацию в БД test (всех операций) с указанием как REPLICA IDENTITY индекса PRIMARY KEY.
2. выполните бакап таблицы, с которой работали в пункте 2 данного задания в формате, чтобы его можно было импортировать командой pg_restore. Удалите эту таблицу и подписку в БД test2 и выполните импортирование этой таблицы в место удаленной реплицируемой (восстановите таблицу с дампа-бакапа).

------

### Правила приема работы

В личном кабинете отправлена ссылка на документ (Google Doc) с выполненным заданием. В документе настроены права доступа “Просматривать могут все в Интернете, у кого есть ссылка”.

------

### Критерии оценки

Зачет - выполнены все задания, ответы даны в развернутой форме, приложены соответствующие скриншоты и файлы проекта, в выполненных заданиях нет противоречий и нарушения логики.

На доработку - задание выполнено частично или не выполнено, в логике выполнения заданий есть противоречия, существенные недостатки.
